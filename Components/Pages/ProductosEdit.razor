@page "/productos/nuevo"
@page "/productos/editar/{id}"
@inject NavigationManager NavMan
@inject IJSRuntime JSx
@rendermode InteractiveServer

@* 1. Reemplazamos la lógica de localStorage por la de servicios de EF Core *@
@using Tarea3.Models
@using Tarea3.Services
@inject ProductoService ProductoServicio

<PageTitle>Producto - @(id == null ? "Nuevo" : "Editar")</PageTitle>
<h3>@(id == null ? "Nuevo Producto" : "Editar Producto")</h3>

<EditForm Model="@producto" OnValidSubmit="@GuardarProducto">
    <DataAnnotationsValidator />

    <div class="card shadow p-4">
        <div class="row">

            <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre del Producto</label>
                <InputText id="nombre" class="form-control" @bind-Value="@producto.Nombre" />
                <ValidationMessage For="@(() => producto.Nombre)" />
            </div>

            <div class="col-md-6 mb-3">
                <label for="fechaIngreso" class="form-label">Fecha de Ingreso</label>
                <InputDate id="fechaIngreso" class="form-control" @bind-Value="@producto.FechaIngreso" />
                <ValidationMessage For="@(() => producto.FechaIngreso)" />
            </div>

            <div class="col-md-4 mb-3">
                <label for="precioUnitario" class="form-label">Precio Unitario ($)</label>
                <InputNumber id="precioUnitario" class="form-control" @bind-Value="@producto.PrecioUnitario" />
                <ValidationMessage For="@(() => producto.PrecioUnitario)" />
            </div>

            <div class="col-md-4 mb-3">
                <label for="stockActual" class="form-label">Stock Actual</label>
                <InputNumber id="stockActual" class="form-control" @bind-Value="@producto.StockActual" />
                <ValidationMessage For="@(() => producto.StockActual)" />
            </div>

            <div class="col-md-4 mb-3">
                <label for="codigoSKU" class="form-label">Código SKU</label>
                @* ⚠️ Nota: El modelo Producto.cs original no tenía CodigoSKU. *@@* Asegúrate de agregarlo a Models/Producto.cs si lo quieres usar. *@
                <InputText id="codigoSKU" class="form-control" @bind-Value="@producto.CodigoSKU" />
            </div>

        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg me-3">
                <i class="oi oi-check"></i> Guardar
            </button>
            <button type="button" class="btn btn-secondary btn-lg" @onclick='() => NavMan.NavigateTo("productos")'>
                <i class="oi oi-x"></i> Cancelar
            </button>
        </div>
    </div>
</EditForm>

@code {
    [Parameter]
    public string? id { get; set; } = null;

    private Producto producto = new Producto();

    // 3. Usamos OnInitializedAsync para cargar el producto, si existe (edición)
    protected override async Task OnInitializedAsync()
    {
        if (id != null)
        {
            // Busca el producto en la base de datos
            var productoDb = await ProductoServicio.GetProductoByIdAsync(id);
            if (productoDb != null)
            {
                producto = productoDb;
            }
            else
            {
                // Si no se encuentra, regresa a la lista
                NavMan.NavigateTo("productos");
            }
        }
    }
    
    // 3. Actualizamos la lógica de guardar para usar los métodos del servicio
    private async Task GuardarProducto()
    {
        if (string.IsNullOrEmpty(producto.Id) || id == null)
        {
            // Crear nuevo (EF Core generará el ID si usaste Guid.NewGuid().ToString() en el modelo)
            await ProductoServicio.AddProductoAsync(producto);
            await JSx.InvokeVoidAsync("alert", $"Producto '{producto.Nombre}' creado con éxito!");
        }
        else
        {
            // Editar existente
            await ProductoServicio.UpdateProductoAsync(producto);
            await JSx.InvokeVoidAsync("alert", $"Producto '{producto.Nombre}' actualizado con éxito!");
        }

        // Navegar de vuelta a la lista
        NavMan.NavigateTo("productos");
    }
}